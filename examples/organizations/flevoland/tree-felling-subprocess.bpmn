<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
  id="Definitions_TreeFellingSubProcess"
  targetNamespace="http://example.com/tree-permit"
  exporter="Camunda Modeler"
  exporterVersion="5.36.0">

  <!--
    TreeFellingPermitSubProcess
    ===========================
    Material law layer for the Tree Felling Permit.
    Called by the AWB Shell Process (AwbShellProcess) via a Call Activity.

    Inputs  (from AWB parent via camunda:in variables="all"):
      - treeDiameter   (Integer) : trunk diameter in cm at 1.30m height
      - protectedArea  (Boolean) : whether tree is in a protected area

    Outputs (to AWB parent via camunda:out variables="all"):
      - permitDecision       (String)  : "Permit" or "Reject"
      - replacementDecision  (Boolean) : true if replacement tree required
      - status               (String)  : "Approved" or "Rejected"
      - finalMessage         (String)  : human-readable decision message
      - replacementInfo      (String)  : replacement requirement description
      - decisionType         (String)  : "Granted" or "Rejected" (for Archives DMN)
      - paymentRequired      (Boolean) : whether a fee is due
      - chainProcessRequired (Boolean) : whether to forward to chain process

    Legal basis: APV (Local Government By-law) - material law
  -->

  <bpmn:process id="TreeFellingPermitSubProcess" name="Tree Felling Permit - Processing and Decision" isExecutable="true" camunda:historyTimeToLive="180">

    <!-- No form on StartEvent - variables come from AWB parent Call Activity -->
    <bpmn:startEvent id="SubStart" name="Start processing">
      <bpmn:outgoing>Flow_Sub_Start_Assess</bpmn:outgoing>
    </bpmn:startEvent>

    <bpmn:businessRuleTask id="Sub_AssessPermit" name="Assess tree felling permit (APV)" camunda:resultVariable="permitDecision" camunda:decisionRef="TreeFellingDecision" camunda:mapDecisionResult="singleEntry">
      <bpmn:incoming>Flow_Sub_Start_Assess</bpmn:incoming>
      <bpmn:outgoing>Flow_Sub_Assess_Gateway</bpmn:outgoing>
    </bpmn:businessRuleTask>

    <bpmn:exclusiveGateway id="Sub_Gateway_Permit" name="Permit granted?">
      <bpmn:incoming>Flow_Sub_Assess_Gateway</bpmn:incoming>
      <bpmn:outgoing>Flow_Sub_Permit_Yes</bpmn:outgoing>
      <bpmn:outgoing>Flow_Sub_Permit_No</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:businessRuleTask id="Sub_AssessReplacement" name="Assess replacement tree requirement" camunda:resultVariable="replacementDecision" camunda:decisionRef="ReplacementTreeDecision" camunda:mapDecisionResult="singleEntry">
      <bpmn:incoming>Flow_Sub_Permit_Yes</bpmn:incoming>
      <bpmn:outgoing>Flow_Sub_Replacement_Granted</bpmn:outgoing>
    </bpmn:businessRuleTask>

    <bpmn:scriptTask id="Sub_SetGranted" name="Set decision variables: Granted" scriptFormat="javascript">
      <bpmn:incoming>Flow_Sub_Replacement_Granted</bpmn:incoming>
      <bpmn:outgoing>Flow_Sub_Granted_End</bpmn:outgoing>
      <bpmn:script><![CDATA[
        execution.setVariable("status", "Approved");
        execution.setVariable("decisionType", "Granted");
        execution.setVariable("finalMessage", "Your tree felling permit has been GRANTED.");
        execution.setVariable("paymentRequired", false);
        execution.setVariable("chainProcessRequired", false);

        var replacement = execution.getVariable("replacementDecision");
        var replacementText;
        if (replacement === true || replacement === "true") {
          replacementText = "Replacement tree REQUIRED - you are obligated to plant a replacement tree.";
        } else {
          replacementText = "No replacement tree required.";
        }
        execution.setVariable("replacementInfo", replacementText);
      ]]></bpmn:script>
    </bpmn:scriptTask>

    <bpmn:scriptTask id="Sub_SetRejected" name="Set decision variables: Rejected" scriptFormat="javascript">
      <bpmn:incoming>Flow_Sub_Permit_No</bpmn:incoming>
      <bpmn:outgoing>Flow_Sub_Rejected_End</bpmn:outgoing>
      <bpmn:script><![CDATA[
        execution.setVariable("status", "Rejected");
        execution.setVariable("decisionType", "Rejected");
        execution.setVariable("finalMessage", "Your tree felling permit has been REJECTED. You may appeal within 6 weeks (Awb 6:7).");
        execution.setVariable("replacementInfo", "N/A - permit was rejected.");
        execution.setVariable("paymentRequired", false);
        execution.setVariable("chainProcessRequired", false);
      ]]></bpmn:script>
    </bpmn:scriptTask>

    <bpmn:endEvent id="SubEnd" name="Decision ready">
      <bpmn:incoming>Flow_Sub_Granted_End</bpmn:incoming>
      <bpmn:incoming>Flow_Sub_Rejected_End</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="Flow_Sub_Start_Assess"        sourceRef="SubStart"               targetRef="Sub_AssessPermit" />
    <bpmn:sequenceFlow id="Flow_Sub_Assess_Gateway"      sourceRef="Sub_AssessPermit"        targetRef="Sub_Gateway_Permit" />
    <bpmn:sequenceFlow id="Flow_Sub_Permit_Yes" sourceRef="Sub_Gateway_Permit" targetRef="Sub_AssessReplacement">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${permitDecision == "Permit"}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_Sub_Permit_No" sourceRef="Sub_Gateway_Permit" targetRef="Sub_SetRejected">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${permitDecision == "Reject"}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_Sub_Replacement_Granted" sourceRef="Sub_AssessReplacement"   targetRef="Sub_SetGranted" />
    <bpmn:sequenceFlow id="Flow_Sub_Granted_End"         sourceRef="Sub_SetGranted"           targetRef="SubEnd" />
    <bpmn:sequenceFlow id="Flow_Sub_Rejected_End"        sourceRef="Sub_SetRejected"          targetRef="SubEnd" />

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_Sub">
    <bpmndi:BPMNPlane id="BPMNPlane_Sub" bpmnElement="TreeFellingPermitSubProcess">
      <bpmndi:BPMNShape id="SubStart_di" bpmnElement="SubStart">
        <dc:Bounds x="152" y="116" width="36" height="36" />
        <bpmndi:BPMNLabel><dc:Bounds x="130" y="159" width="80" height="27" /></bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Sub_AssessPermit_di" bpmnElement="Sub_AssessPermit">
        <dc:Bounds x="248" y="94" width="160" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Sub_Gateway_Permit_di" bpmnElement="Sub_Gateway_Permit" isMarkerVisible="true">
        <dc:Bounds x="468" y="109" width="50" height="50" />
        <bpmndi:BPMNLabel><dc:Bounds x="460" y="85" width="66" height="14" /></bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Sub_AssessReplacement_di" bpmnElement="Sub_AssessReplacement">
        <dc:Bounds x="578" y="94" width="160" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Sub_SetGranted_di" bpmnElement="Sub_SetGranted">
        <dc:Bounds x="798" y="94" width="160" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Sub_SetRejected_di" bpmnElement="Sub_SetRejected">
        <dc:Bounds x="578" y="250" width="160" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SubEnd_di" bpmnElement="SubEnd">
        <dc:Bounds x="1020" y="116" width="36" height="36" />
        <bpmndi:BPMNLabel><dc:Bounds x="996" y="159" width="84" height="27" /></bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_Sub_Start_Assess_di"       bpmnElement="Flow_Sub_Start_Assess">       <di:waypoint x="188" y="134" /><di:waypoint x="248" y="134" /></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Sub_Assess_Gateway_di"     bpmnElement="Flow_Sub_Assess_Gateway">     <di:waypoint x="408" y="134" /><di:waypoint x="468" y="134" /></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Sub_Permit_Yes_di"         bpmnElement="Flow_Sub_Permit_Yes">         <di:waypoint x="518" y="134" /><di:waypoint x="578" y="134" /></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Sub_Permit_No_di"          bpmnElement="Flow_Sub_Permit_No">          <di:waypoint x="493" y="159" /><di:waypoint x="493" y="290" /><di:waypoint x="578" y="290" /></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Sub_Replacement_Granted_di" bpmnElement="Flow_Sub_Replacement_Granted"><di:waypoint x="738" y="134" /><di:waypoint x="798" y="134" /></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Sub_Granted_End_di"        bpmnElement="Flow_Sub_Granted_End">        <di:waypoint x="958" y="134" /><di:waypoint x="1020" y="134" /></bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Sub_Rejected_End_di"       bpmnElement="Flow_Sub_Rejected_End">       <di:waypoint x="738" y="290" /><di:waypoint x="1038" y="290" /><di:waypoint x="1038" y="152" /></bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>